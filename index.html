<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Breach Cost Estimator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ajv/8.12.0/ajv7.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        /* Dark mode by default */
        body.dark {
            background-color: #1a202c;
            color: #e2e8f0;
        }
        .dark .bg-white { background-color: #2d3748 !important; }
        .dark .text-black { color: #e2e8f0 !important; }
        .dark .bg-gray-100 { background-color: #1a202c !important; }
        .dark .border-gray-300 { border-color: #4a5568 !important; }
    
        /* Progress Bar */
        .progress-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        .progress-bar li {
            list-style: none;
            width: 100%;
            text-align: center;
            position: relative;
            font-weight: bold;
            color: gray;
        }
        .progress-bar li:before {
            content: attr(data-step);
            display: block;
            margin: 0 auto;
            width: 30px;
            height: 30px;
            line-height: 30px;
            border-radius: 50%;
            background-color: gray;
            color: white;
        }
        .progress-bar li.active {
            color: #3490dc;
        }
        .progress-bar li.active:before {
            background-color: #3490dc;
        }
    
        /* Hide all form steps by default */
        .form-step {
            display: none;
        }
    
        /* Only display the form-step that has the 'active' class */
        .form-step.active {
            display: block;
        }
    
        /* Loading Indicator */
        #loading-icon {
            display: none;
            font-size: 14px;
            color: #3490dc;
            animation: spin 1s linear infinite;
        }
    
        /* Loading Animation */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    
        /* Styling for asset selection */
        #asset-category-container label {
            display: block;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin: 5px 0;
            cursor: pointer;
        }
        #asset-category-container input[type="radio"] {
            display: none;
        }
        #asset-category-container input[type="radio"]:checked + label {
            background-color: #3490dc;
            color: white;
            border-color: #3490dc;
        }
    
        /* Styling for form fields */
        select, input[type="text"], input[type="number"] {
            background-color: #2d3748;
            border: 1px solid #ddd;
            padding: 8px;
            width: 100%;
            border-radius: 5px;
        }
    
        /* Button styles */
        button {
            cursor: pointer;
            border: none;
            font-size: 16px;
            font-weight: bold;
            padding: 10px;
            border-radius: 5px;
        }
        .btn-primary {
            background-color: #3490dc;
            color: white;
        }
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        .btn-success {
            background-color: #38a169;
            color: white;
        }
        .btn-danger {
            background-color: #e3342f;
            color: white;
        }
        .btn-primary:hover { background-color: #2779bd; }
        .btn-secondary:hover { background-color: #5a6268; }
        .btn-success:hover { background-color: #2f855a; }
        .btn-danger:hover { background-color: #cc1f1a; }
    
        /* JSON Output */
        #json-output {
            white-space: pre-wrap;
            word-wrap: break-word;
            background-color: #f7fafc;
            color: black;
            padding: 10px;
            border-radius: 5px;
            display: none;
        }
        /* Drawer Default Styling */
        .model-drawer {
            position: fixed;
            top: 0;
            right: -350px; /* Initially Hidden */
            width: 350px;
            height: 100%;
            background-color: #2d3748;
            color: white;
            overflow-y: auto;
            box-shadow: -2px 0 5px rgba(0, 0, 0, 0.5);
            transition: right 0.3s ease-in-out;
            padding: 20px;
        }

        /* When Opened */
        .model-drawer.open {
            right: 0;
        }

        /* Drawer Tab */
        .drawer-tab {
            position: absolute;
            left: -50px;
            top: 50%;
            width: 50px;
            height: 100px;
            background-color: #3490dc;
            color: white;
            border: none;
            border-radius: 5px 0 0 5px;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }

        /* Move Tab Inside Drawer When Expanded */
        .model-drawer.open .drawer-tab {
            left: 10px;
            background-color: #1e3a8a;
        }

        /* JSON Styling */
        .json-content {
            white-space: pre-wrap;
            word-wrap: break-word;
            background-color: #1a202c;
            color: #e2e8f0;
            padding: 10px;
            border-radius: 5px;
        }
        #progress-container {
            display: none;
        }

        #radial-tree-container {
            width: 100%;
            height: 600px;
            overflow: hidden;
            position: relative;
        }

    </style>
    
</head>
<body class="dark flex justify-center items-center min-h-screen">
    <!-- Toast Notification Container -->
    <div id="toast-container" class="fixed bottom-5 right-5 space-y-2 z-50"></div>
    <!-- Main Form Container -->
    <div class="bg-white shadow-md rounded-lg p-6 w-full max-w-2xl">
            <!-- Progress Bar -->
            <div id="progress-container" class="w-full bg-gray-300 rounded mt-4 hidden">
                <div id="progress-bar" class="h-4 bg-blue-500 rounded w-0"></div>
            </div>
        <div class="flex justify-between items-center">
            <h2 class="text-xl font-bold">Data Breach Cost Estimator</h2>
            <button id="darkModeToggle" class="px-3 py-1 text-sm bg-gray-700 text-white rounded">
                <span id="darkModeIcon" class="material-symbols-outlined">dark_mode</span>
            </button>            
        </div>

        <!-- Progress Bar -->
        <ol class="progress-bar flex">
            <li data-step="1" class="active">Organization</li>
            <li data-step="2">Asset Types</li>
            <li data-step="3">MITRE ATT&CK Inventory</li>
            <li data-step="4">ATT&CK Technique Visualization</li>
        </ol>

        <form id="multiStepForm">
            <!-- Step 1: Organization Details -->
            <div class="form-step active">
                <h3 class="text-lg font-semibold mb-2">Organization Details</h3>
                <p class="text-sm text-gray-600 mb-2">Define your organization's security practices.</p>

                <div id="organization-details">
                    <label class="block mt-2">
                        <input type="checkbox" id="ai_automation" class="mr-2">
                        AI & Automation for Information Security
                    </label>
                    <label class="block mt-2">
                        <input type="checkbox" id="cybersecurity_training_security_staff" class="mr-2">
                        Cybersecurity Training for Security Staff
                    </label>
                    <label class="block mt-2">
                        <input type="checkbox" id="cybersecurity_training_all_employees" class="mr-2">
                        Cybersecurity Training for All Employees
                    </label>
                    <label class="block mt-2">
                        <input type="checkbox" id="incident_response_testing" class="mr-2">
                        Conduct Incident Response Tests
                    </label>
                    <label class="block mt-2">
                        <input type="checkbox" id="law_enforcement_ransomware" class="mr-2">
                        Engage Law Enforcement for Ransomware
                    </label>
                    <label class="block mt-2">
                        <input type="checkbox" id="data_encryption" class="mr-2">
                        Encrypt Stored Data (Beyond Disk Encryption)
                    </label>
                </div>

                <button type="button" class="next-step bg-blue-500 text-white px-4 py-2 rounded mt-4">Next</button>
            </div>

            <!-- Step 2: Asset Types -->
            <div class="form-step">
                <h3 class="text-lg font-semibold mb-2">Define Asset Types</h3>
                <p class="text-sm text-gray-600 mb-2">Select an asset category to continue.</p>

                <!-- Asset Category Selection -->
                <div id="asset-category-container">
                    <label class="block mt-2">
                        <input type="radio" name="asset-category" value="devices" class="mr-2"> Devices
                    </label>
                    <label class="block mt-2">
                        <input type="radio" name="asset-category" value="networks" class="mr-2"> Networks
                    </label>
                    <label class="block mt-2">
                        <input type="radio" name="asset-category" value="applications" class="mr-2"> Applications & Workloads
                    </label>
                    <label class="block mt-2">
                        <input type="radio" name="asset-category" value="data" class="mr-2"> Data
                    </label>
                    <label class="block mt-2">
                        <input type="radio" name="asset-category" value="identities" class="mr-2"> Identities
                    </label>
                </div>

                <!-- Asset Type Selection -->
                <label class="block mt-2">Select Asset Type:
                    <select id="asset-type-dropdown" class="border p-2 w-full" disabled>
                        <option value="">Select an asset category first</option>
                    </select>
                    <span id="loading-icon" class="ml-2" style="display: none;">Loading...</span>
                </label>

                <!-- Environment Selection -->
                <div id="environment-selection" class="mt-4" style="display: none;">
                    <label class="block mt-2">Environment:
                        <select id="environment-dropdown" class="border p-2 w-full"></select>
                    </label>
                </div>

                <!-- Record Count Selection (Only for Data) -->
                <div id="record-count-selection" class="mt-4" style="display: none;">
                    <label class="block mt-2">Estimated Record Count:
                        <select id="record-count-dropdown" class="border p-2 w-full"></select>
                    </label>
                </div>

                <!-- Monitoring Coverage Selection -->
                <div id="monitoring-selection" class="mt-4" style="display: none;">
                    <label class="block mt-2">Monitoring Coverage:</label>
                    <div id="network-monitoring" data-label="Network Monitoring"></div>
                    <div id="process-monitoring" data-label="Process Monitoring"></div>
                    <div id="file-monitoring" data-label="File Monitoring"></div>
                    <div id="cloud-monitoring" data-label="Cloud Monitoring"></div>
                    <div id="hardware-monitoring" data-label="Hardware Monitoring"></div>
                </div>

                <!-- Submit Asset Type -->
                <button type="button" id="submit-asset-type" class="bg-green-500 text-white px-4 py-2 rounded mt-4" style="display: none;">
                    Add Asset Type
                </button>

                <!-- Button to Add Another Asset Type -->
                <button type="button" id="add-more-assets" class="bg-gray-500 text-white px-4 py-2 rounded mt-4" style="display: none;">
                    Add Another Asset Type
                </button>

                <!-- Display Model Definition in JSON -->
                <button type="button" id="view-model-definition" class="bg-gray-700 text-white px-4 py-2 rounded mt-4" style="display: none;">
                    View Model JSON
                </button>

                <button type="button" class="prev-step bg-gray-500 text-white px-4 py-2 rounded mt-4">Back</button>
                <button type="button" class="next-step bg-blue-500 text-white px-4 py-2 rounded mt-4">Next</button>
            </div>

            <!-- Step 3: Technique Scoring -->
            <div class="form-step">
                <h3 class="text-lg font-semibold mb-2">MITRE ATT&CK Techniques Inventory</h3>
                <p class="text-sm text-gray-600 mb-4">Review the MITRE ATT&CK techniques relevant to each asset type.</p>
            
                <!-- Summary Table -->
                <table id="model-summary-table" class="w-full border-collapse border border-gray-300 text-sm">
                    <thead>
                        <tr class="bg-gray-700 text-white">
                            <th class="border border-gray-300 px-4 py-2">Environment</th>
                            <th class="border border-gray-300 px-4 py-2">Asset Category</th>
                            <th class="border border-gray-300 px-4 py-2">Asset Type</th>
                            <th class="border border-gray-300 px-4 py-2">Count of MITRE ATT&CK Techniques</th>
                        </tr>
                    </thead>
                    <tbody id="model-summary-body"></tbody>
                </table>
            
                <!-- Techniques Table Container -->
                <div id="techniques-container" class="hidden mt-6">
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="text-md font-semibold">Techniques for <span id="selected-asset-type"></span></h4>
                        <button id="toggle-techniques-btn" type="button" bg-gray-600 text-white px-3 py-1 rounded">
                            Hide Techniques
                        </button>
                    </div>

                    <table id="techniques-table" class="w-full border-collapse border border-gray-300 text-sm">
                        <thead>
                            <tr class="bg-gray-700 text-white">
                                <th class="border border-gray-300 px-4 py-2">ATT&CK Technique ID</th>
                                <th class="border border-gray-300 px-4 py-2">ATT&CK Technique Name</th>
                                <th class="border border-gray-300 px-4 py-2">ATT&CK Score</th>
                            </tr>
                        </thead>
                        <tbody id="techniques-body"></tbody>
                    </table>
                </div>

                <button type="button" id="download-json" class="bg-blue-500 text-white px-4 py-2 rounded mt-4">Download JSON</button>
                <button type="button" class="prev-step bg-gray-500 text-white px-4 py-2 rounded mt-4">Back</button>
                <button type="button" class="next-step bg-blue-500 text-white px-4 py-2 rounded mt-4" id="go-to-visualization">Next</button>

            </div>

            <!-- Step 4: Radial Tree Visualization -->
            <div class="form-step">
                <h3 class="text-lg font-semibold mb-2">ATT&CK Technique Visualization</h3>
                <p class="text-sm text-gray-600 mb-4">Select a category to visualize:</p>

                <!-- Radio Button Selection for Correlation Type -->
                <div id="visualization-selection" class="mb-4">
                    <label><input type="radio" name="visualization-type" value="detections" checked> ATT&CK Detections</label>
                    <label><input type="radio" name="visualization-type" value="mitigations"> ATT&CK Mitigations</label>
                    <label><input type="radio" name="visualization-type" value="nist"> NIST Controls</label>
                    <label><input type="radio" name="visualization-type" value="cis"> CIS Safeguards</label>
                    <label><input type="radio" name="visualization-type" value="aws"> AWS Capabilities</label>
                    <label><input type="radio" name="visualization-type" value="gcp"> GCP Capabilities</label>
                    <label><input type="radio" name="visualization-type" value="azure"> Azure Capabilities</label>
                    <label><input type="radio" name="visualization-type" value="m365"> M365 Capabilities</label>
                </div>

                <!-- Radial Tree Visualization Container -->
                <div id="radial-tree-container" class="w-full h-96 border border-gray-300 rounded bg-white"></div>

                <!-- Navigation Buttons -->
                <button type="button" class="prev-step bg-gray-500 text-white px-4 py-2 rounded mt-4">Back</button>
                <button type="button" id="download-json" class="bg-blue-500 text-white px-4 py-2 rounded mt-4">Download JSON</button>
            </div>

            
        </form>

        <!-- JSON Output -->
        <pre id="json-output" class="bg-gray-100 text-black p-4 rounded mt-4" style="display: none;"></pre>
    </div>
    <!-- Collapsible Drawer -->
    <div id="model-drawer" class="model-drawer">
        <button id="drawer-tab" class="drawer-tab">Model JSON</button>
        <pre id="json-output" class="json-content"></pre>
    </div>
    <script>
        // Initialize IndexedDB
        async function initIndexedDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open("DataCacheDB", 1);
    
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
    
                    // Create object stores if they don't exist
                    const stores = [
                        { name: "techniques", keyPath: "id" },
                        { name: "dataSources", keyPath: "id" },
                        { name: "securityMappings", keyPath: "attack_object_id" },
                        { name: "weightKeywords", keyPath: "keywords" },
                        { name: "assets", keyPath: "id" },
                        { name: "visualizationTree", keyPath: "id" },
                        { name: "settings", keyPath: "key" } // Store dark mode, preferences
                    ];
    
                    stores.forEach(store => {
                        if (!db.objectStoreNames.contains(store.name)) {
                            db.createObjectStore(store.name, { keyPath: store.keyPath });
                        }
                    });
                };
    
                request.onsuccess = (event) => resolve(event.target.result);
                request.onerror = (event) => reject(event.target.error);
            });
        }
    
        // Store an object in IndexedDB
        async function storeObject(storeName, data) {
            const db = await initIndexedDB();
            const transaction = db.transaction(storeName, "readwrite");
            const store = transaction.objectStore(storeName);
            store.put(data);
        }
    
        // Get an object by ID
        async function getObjectById(storeName, id) {
            const db = await initIndexedDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, "readonly");
                const store = transaction.objectStore(storeName);
                const request = store.get(id);
    
                request.onsuccess = () => resolve(request.result || null);
                request.onerror = () => reject(null);
            });
        }
    
        // Get all objects in a store
        async function getAllObjects(storeName) {
            const db = await initIndexedDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, "readonly");
                const store = transaction.objectStore(storeName);
                const request = store.getAll();
    
                request.onsuccess = () => resolve(request.result || []);
                request.onerror = () => reject([]);
            });
        }
    
        // Multi-Step Form Navigation
        function showStep(step) {
            document.querySelectorAll(".form-step").forEach((el, index) => {
                el.style.display = index === step ? "block" : "none";
            });
        }
    
        document.addEventListener("DOMContentLoaded", () => {
            showStep(0); // Show first step
            document.querySelectorAll(".next-step").forEach(btn => btn.addEventListener("click", () => showStep(1)));
            document.querySelectorAll(".prev-step").forEach(btn => btn.addEventListener("click", () => showStep(0)));
        });
    
        // Populate Asset Categories & Types
        async function populateAssetCategories() {
            const assetCategories = await getAllObjects("assets");
            const container = document.getElementById("asset-category-container");
            container.innerHTML = assetCategories.map(asset => `
                <button class="asset-category" data-category="${asset.id}">${asset.name}</button>
            `).join("");
    
            document.querySelectorAll(".asset-category").forEach(btn => {
                btn.addEventListener("click", () => populateAssetTypes(btn.dataset.category));
            });
        }
    
        async function populateAssetTypes(categoryId) {
            const asset = await getObjectById("assets", categoryId);
            const dropdown = document.getElementById("asset-type-dropdown");
            dropdown.innerHTML = asset.types.map(type => `<option value="${type}">${type}</option>`).join("");
        }
    
        // Calculate ATT&CK Technique Scores
        async function calculateAllTechniqueScores() {
            const techniques = await getAllObjects("techniques");
            techniques.forEach(async technique => {
                technique.score = await calculateTechniqueScore(technique.id);
                await storeObject("techniques", technique);
            });
            showToast("Technique scores updated.");
        }
    
        async function calculateTechniqueScore(techniqueId) {
            const technique = await getObjectById("techniques", techniqueId);
            return technique.riskScore.total;
        }
    
        // Generate Radial Tree Visualization
        async function generateRadialTree() {
            const techniques = await getAllObjects("visualizationTree");
    
            const svg = d3.select("#radial-tree-container").append("svg")
                .attr("width", 800).attr("height", 600)
                .append("g").attr("transform", "translate(400,300)");
    
            const hierarchy = d3.hierarchy({ children: techniques });
            const treeLayout = d3.tree().size([360, 250]);
            treeLayout(hierarchy);
    
            svg.selectAll("line")
                .data(hierarchy.links())
                .enter()
                .append("line")
                .attr("x1", d => d.source.x).attr("y1", d => d.source.y)
                .attr("x2", d => d.target.x).attr("y2", d => d.target.y)
                .attr("stroke", "black");
        }
    
        // Dark Mode Toggle
        async function toggleDarkMode() {
            const body = document.body;
            body.classList.toggle("dark");
            const mode = body.classList.contains("dark") ? "dark" : "light";
            await storeObject("settings", { key: "darkMode", value: mode });
        }
    
        document.addEventListener("DOMContentLoaded", async () => {
            const savedMode = await getObjectById("settings", "darkMode");
            if (savedMode) document.body.classList.toggle("dark", savedMode.value === "dark");
        });
    
        // JSON Export & Download
        async function exportModelAsJSON() {
            const techniques = await getAllObjects("techniques");
            const blob = new Blob([JSON.stringify(techniques, null, 2)], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "model-data.json";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
    
        document.getElementById("download-json").addEventListener("click", exportModelAsJSON);
    
        // Toast Notification
        function showToast(message) {
            const toast = document.getElementById("toast");
            toast.innerText = message;
            toast.style.display = "block";
            setTimeout(() => toast.style.display = "none", 3000);
        }
    
        // Initialize App
        document.addEventListener("DOMContentLoaded", async () => {
            await initIndexedDB();
            await populateAssetCategories();
            await generateRadialTree();
        });
    </script>     
  
</body>

</html>
